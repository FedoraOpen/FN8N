<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Gynécologie-Obstétrique</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
        #chatbox { height: 400px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        .message { margin-bottom: 10px; padding: 8px; border-radius: 5px; }
        .user { background-color: #e1f5fe; text-align: right; margin-left: 40px; }
        .bot { background-color: #f1f1f1; margin-right: 40px; }
        #userInput { width: calc(100% - 80px); padding: 10px; }
        #sendButton { padding: 10px; }
        .loading { font-style: italic; color: #888; }
    </style>
</head>
<body>

    <h1>Chatbot Professeur Gynéco-Obs</h1>
    <div id="chatbox">
        </div>
    <form id="messageForm">
        <input type="text" id="userInput" placeholder="Entrez votre message..." required>
        <button type="submit" id="sendButton">Envoyer</button>
    </form>

    <script>
        const chatbox = document.getElementById('chatbox');
        const messageForm = document.getElementById('messageForm');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');

        // --- Gestion du Session ID ---
        let sessionId = sessionStorage.getItem('chatbotSessionId');
        if (!sessionId) {
            // Génère un ID unique si non existant dans la session du navigateur
            sessionId = `session_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;
            sessionStorage.setItem('chatbotSessionId', sessionId);
            console.log('New Session ID generated:', sessionId);
        } else {
            console.log('Using existing Session ID:', sessionId);
        }
        // --- Fin Gestion du Session ID ---

        // URL de votre Webhook N8N
        const webhookUrl = 'VOTRE_URL_WEBHOOK_N8N_ICI'; // IMPORTANT: Remplacez par votre URL !

        // Fonction pour ajouter un message au chatbox
        function addMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            // Pour afficher les retours à la ligne correctement
            messageDiv.innerHTML = text.replace(/\n/g, '<br>');
            chatbox.appendChild(messageDiv);
            // Scroll vers le bas
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        // Fonction pour envoyer le message au backend (N8N)
        async function sendMessageToN8N(messageText) {
            addMessage('user', messageText); // Affiche le message de l'utilisateur
            userInput.value = ''; // Vide le champ de saisie
            sendButton.disabled = true; // Désactive le bouton pendant l'attente
            addMessage('loading', 'Professeur réfléchit...'); // Indicateur de chargement

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: messageText,
                        sessionId: sessionId // Inclut le sessionId dans chaque requête
                    })
                });

                // Supprime l'indicateur de chargement
                const loadingMessages = chatbox.getElementsByClassName('loading');
                 while (loadingMessages.length > 0) {
                    loadingMessages[0].remove();
                }

                if (!response.ok) {
                    // Gestion basique des erreurs HTTP
                     const errorText = await response.text();
                    throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
                }

                // N8N renvoie la réponse directement dans le corps (ajuster si format différent)
                const botResponse = await response.text(); // ou response.json() si N8N renvoie du JSON

                 // Si la réponse est du JSON avec une clé spécifique (ex: { "reply": "..." })
                 // Décommentez et adaptez la ligne suivante :
                 // const responseData = JSON.parse(botResponse);
                 // addMessage('bot', responseData.reply || responseData.message || 'Réponse vide.');

                 // Si la réponse est du texte brut (comme configuré dans votre 'Respond to Webhook')
                 addMessage('bot', botResponse || 'Réponse vide.');


            } catch (error) {
                 console.error('Erreur lors de l\'envoi/réception du message:', error);
                addMessage('bot', `Désolé, une erreur est survenue: ${error.message}`);
                 // Supprime aussi l'indicateur de chargement en cas d'erreur
                 const loadingMessages = chatbox.getElementsByClassName('loading');
                 while (loadingMessages.length > 0) {
                    loadingMessages[0].remove();
                 }
            } finally {
                 sendButton.disabled = false; // Réactive le bouton
                 userInput.focus(); // Remet le focus sur le champ de saisie
            }
        }

        // Gestion de la soumission du formulaire
        messageForm.addEventListener('submit', (event) => {
            event.preventDefault(); // Empêche le rechargement de la page
            const messageText = userInput.value.trim();
            if (messageText) {
                sendMessageToN8N(messageText);
            }
        });

        // Optionnel: Envoyer un message initial ou attendre le premier message de l'utilisateur
        // Pour déclencher le "Bonjour, merci de me communiquer votre Nom et Prénom."
        // Vous pouvez soit envoyer un message vide/spécifique au chargement,
        // soit laisser l'utilisateur envoyer le premier message.
        // Exemple d'envoi automatique au chargement (si nécessaire) :
        // document.addEventListener('DOMContentLoaded', () => {
        //     sendMessageToN8N("Bonjour"); // Ou un autre message déclencheur si besoin
        // });

         // Affiche un message initial du bot (si non géré par un message automatique)
         addMessage('bot', 'Bonjour, je suis votre professeur virtuel. Veuillez commencer par indiquer votre Nom et Prénom pour démarrer l\'évaluation.');


    </script>

</body>
</html>